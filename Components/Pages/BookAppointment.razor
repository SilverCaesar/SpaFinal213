@page "/book-appointment"
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using SpaFinal213.Data
@using SpaFinal213.Models
@inject ApplicationDbContext Db
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Book Appointment</PageTitle>

<h3>Book Appointment</h3>

@if (!string.IsNullOrEmpty(Notification))
{
    <div class="alert alert-info">@Notification</div>
}

<EditForm EditContext="EditContext" OnValidSubmit="HandleValidSubmitAsync" FormName="BookAppointmentForm">
    <DataAnnotationsValidator />
    <ValidationSummary class="text-danger" />

    <!-- Customer Section -->
    <div class="mb-3">
        <label class="form-label">Customer</label>

        <!-- Select mode: existing or new -->
        <InputSelect @bind-Value="Input.CustomerMode" class="form-select" TValue="string"
                     @onchange="OnCustomerModeChanged">
            <option value="existing">Existing customer</option>
            <option value="new">Create new customer</option>
        </InputSelect>

        <!-- Existing customer dropdown -->
        @if (Input.CustomerMode == "existing")
        {
            <div class="mt-2">
                <InputSelect @bind-Value="Input.SelectedCustomerId" class="form-select" TValue="int?">
                    <option value="">-- select customer --</option>
                    @foreach (var c in Customers)
                    {
                        <option value="@c.Customer_Id">@($"{c.Fname} {c.Lname}")</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Input.SelectedCustomerId" class="text-danger" />
            </div>
        }

        <!-- New customer fields -->
        else if (Input.CustomerMode == "new")
        {
        <div class="row g-2 mt-2">
            <div class="col">
                <InputText @bind-Value="Input.NewFName" placeholder="First name" class="form-control" />
                <ValidationMessage For="() => Input.NewFName" class="text-danger" />
            </div>
            <div class="col">
                <InputText @bind-Value="Input.NewLName" placeholder="Last name" class="form-control" />
                <ValidationMessage For="() => Input.NewLName" class="text-danger" />
            </div>
        </div>
        <div class="mt-2">
            <InputTextArea @bind-Value="Input.NewNotes" placeholder="Notes (optional)" class="form-control" />
        </div>
        }
    </div>
    <!-- Employee Selection -->
    <div class="mb-3">
        <label class="form-label">Employee</label>
        <InputSelect @bind-Value="Input.SelectedEmployeeId" class="form-select" TValue="int?">
            <option value="">-- select employee --</option>
            @foreach (var e in Employees)
            {
                <option value="@e.EmployeeId">@($"{e.FName} {e.LName}")</option>
            }
        </InputSelect>
        <ValidationMessage For="() => Input.SelectedEmployeeId" class="text-danger" />
    </div>

    <!-- Service Selection -->
    <div class="mb-3">
        <label class="form-label">Service</label>
        <InputSelect @bind-Value="Input.SelectedServiceId" class="form-select" TValue="int?">
            <option value="">-- select service --</option>
            @foreach (var s in Services)
            {
                <option value="@s.Service_Id">@($"{s.Name} — {s.Duration} min — {s.Price:C}")</option>
            }
        </InputSelect>
        <ValidationMessage For="() => Input.SelectedServiceId" class="text-danger" />
    </div>

    @if (SelectedService != null)
    {
        <div class="mb-3">
            <small class="text-muted">Selected: @SelectedService.Name — @SelectedService.Duration min — @SelectedService.Price:C</small>
        </div>
    }

    <!-- Date & Time -->
    <div class="row g-2 mb-3">
        <div class="col-md-6">
            <label class="form-label">Date</label>
            <InputDate @bind-Value="Input.Date" class="form-control" />
            <ValidationMessage For="() => Input.Date" class="text-danger" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Start Time</label>
            <input type="time" class="form-control" @bind="Input.StartTime" />
            <ValidationMessage For="() => Input.StartTime" class="text-danger" />
        </div>
    </div>

    <!-- Notes -->
    <div class="mb-3">
        <label class="form-label">Notes (optional)</label>
        <InputTextArea @bind-Value="Input.Notes" class="form-control" />
    </div>

    <button type="submit" class="btn btn-primary w-100" disabled="@IsOverlapping">Book Appointment</button>

    @if (IsOverlapping)
    {
        <div class="text-danger mt-2">This employee already has an appointment at the selected date/time.</div>
    }
</EditForm>

@code {
    // Initialize EditContext synchronously so EditForm always has a non-null EditContext
    private EditContext EditContext = default!;

    private List<Customer> Customers = new();
    private List<Employee> Employees = new();
    private List<Service> Services = new();
    private Service? SelectedService;
    private bool IsAuthenticated;
    private string? Notification;
    private bool IsOverlapping = false;

    private InputModel Input { get; set; } = new()
    {
        CustomerMode = "existing",
        Date = DateTime.Today,
        StartTime = TimeOnly.FromTimeSpan(TimeSpan.FromHours(9))
    };

    protected override void OnInitialized()
    {
        // create EditContext synchronously before first render
        EditContext = new EditContext(Input);
        EditContext.OnFieldChanged += EditContext_OnFieldChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        Customers = await Db.Customer.OrderBy(c => c.Fname).ThenBy(c => c.Lname).ToListAsync();
        Employees = await Db.Employee.OrderBy(e => e.FName).ThenBy(e => e.LName).ToListAsync();
        Services = await Db.Service.OrderBy(s => s.Name).ToListAsync();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        IsAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

        if (Services.Count == 1)
        {
            Input.SelectedServiceId = Services[0].Service_Id;
            SelectedService = Services[0];
        }
    }

    private void EditContext_OnFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        // Update SelectedService when the service selection changes.
        if (e.FieldIdentifier.FieldName == nameof(Input.SelectedServiceId))
        {
            SelectedService = Services.FirstOrDefault(s => s.Service_Id == Input.SelectedServiceId);
        }

        // When any of these fields change, re-check for overlapping appointments.
        if (e.FieldIdentifier.FieldName == nameof(Input.SelectedEmployeeId)
            || e.FieldIdentifier.FieldName == nameof(Input.SelectedServiceId)
            || e.FieldIdentifier.FieldName == nameof(Input.Date)
            || e.FieldIdentifier.FieldName == nameof(Input.StartTime))
        {
            _ = InvokeAsync(CheckOverlappingAppointments);
        }

        // Clear/adjust dependent fields when switching customer mode
        if (e.FieldIdentifier.FieldName == nameof(Input.CustomerMode))
        {
            if (Input.CustomerMode == "new")
            {
                Input.SelectedCustomerId = null;
            }
            else
            {
                Input.NewFName = null;
                Input.NewLName = null;
                Input.NewNotes = null;
            }
        }
    }

    private async Task CheckOverlappingAppointments()
    {
        IsOverlapping = false;

        if (!Input.SelectedEmployeeId.HasValue || !Input.SelectedServiceId.HasValue || !Input.StartTime.HasValue)
        {
            StateHasChanged();
            return;
        }

        var service = Services.FirstOrDefault(s => s.Service_Id == Input.SelectedServiceId);
        if (service == null)
        {
            StateHasChanged();
            return;
        }

        var startTime = Input.Date.Date + Input.StartTime.Value.ToTimeSpan();
        var endTime = startTime.AddMinutes(service.Duration);

        IsOverlapping = await Db.Appointment.AnyAsync(a =>
            a.Employee_Id == Input.SelectedEmployeeId.Value &&
            a.Date.Date == Input.Date.Date &&
            ((a.Start < endTime) && (a.Start.AddMinutes(a.Duration) > startTime))
        );

        StateHasChanged();
    }

    private async Task HandleValidSubmitAsync()
    {
        Notification = null;

        if (IsOverlapping)
        {
            Notification = "Cannot book: selected employee is busy at that time.";
            return;
        }

        if (!Input.StartTime.HasValue)
        {
            Notification = "Please specify a start time.";
            return;
        }

        int customerId;
        if (Input.CustomerMode == "new")
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var appUser = await UserManager.GetUserAsync(authState.User);

            var newCustomer = new Customer
            {
                ApplicationUserId = appUser?.Id,
                Fname = Input.NewFName?.Trim() ?? string.Empty,
                Lname = Input.NewLName?.Trim() ?? string.Empty,
                Notes = Input.NewNotes,
                DateAccount = DateTime.UtcNow
            };

            Db.Customer.Add(newCustomer);
            await Db.SaveChangesAsync();
            customerId = newCustomer.Customer_Id;
        }
        else
        {
            if (!Input.SelectedCustomerId.HasValue)
            {
                Notification = "Please select an existing customer or create a new one.";
                return;
            }
            customerId = Input.SelectedCustomerId.Value;
        }

        var service = Services.FirstOrDefault(s => s.Service_Id == Input.SelectedServiceId);
        if (service == null)
        {
            Notification = "Selected service no longer exists.";
            return;
        }

        var appointmentStart = Input.Date.Date + Input.StartTime.Value.ToTimeSpan();

        var appointment = new Appointment
        {
            Customer_Id = customerId,
            Employee_Id = Input.SelectedEmployeeId,
            Service_Id = service.Service_Id,
            Date = Input.Date.Date,
            Start = appointmentStart,
            Duration = service.Duration,
            Price = service.Price,
            Status = "Scheduled",
            Notes = Input.Notes
        };

        Db.Appointment.Add(appointment);
        await Db.SaveChangesAsync();

        Notification = "Appointment booked successfully.";
        Navigation.NavigateTo("/appointments");
    }

    private class InputModel
    {
        // "existing" or "new"
        public string CustomerMode { get; set; } = "existing";

        public int? SelectedCustomerId { get; set; }

        [RequiredIfNewCustomer]
        public string? NewFName { get; set; }
        [RequiredIfNewCustomer]
        public string? NewLName { get; set; }
        public string? NewNotes { get; set; }

        [Required]
        public int? SelectedEmployeeId { get; set; }
        [Required]
        public int? SelectedServiceId { get; set; }

        [Required]
        public DateTime Date { get; set; }

        [Required]
        public TimeOnly? StartTime { get; set; }

        public string? Notes { get; set; }
    }

    private class RequiredIfNewCustomerAttribute : ValidationAttribute
    {
        protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)
        {
            var instance = (InputModel?)validationContext.ObjectInstance;
            if (instance is null) return ValidationResult.Success;

            if (instance.CustomerMode == "new")
            {
                if (value is string s && !string.IsNullOrWhiteSpace(s))
                    return ValidationResult.Success;
                return new ValidationResult("This field is required when creating a new customer.");
            }

            return ValidationResult.Success;
        }
    }

    public void Dispose()
    {
        if (EditContext is not null)
            EditContext.OnFieldChanged -= EditContext_OnFieldChanged;
    }

    private void OnCustomerModeChanged(ChangeEventArgs e)
    {
        var mode = e.Value?.ToString() ?? "existing";
        Input.CustomerMode = mode;

        // Clear irrelevant fields when switching modes
        if (mode == "existing")
        {
            Input.NewFName = null;
            Input.NewLName = null;
            Input.NewNotes = null;
        }
        else // new
        {
            Input.SelectedCustomerId = null;
        }
    }
}