@page "/bookappointment"
@using Microsoft.EntityFrameworkCore
@using SpaFinal213.Components.Shared
@using SpaFinal213.Models
@inject IDbContextFactory<SpaFinal213.Data.ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject ILoggerFactory LoggerFactory

<PageTitle>Create</PageTitle>

<div class="centered-panel">
    <div class="panel-inner">
        <div class="panel-card" style="flex: 1 1 520px;">
            <h1>Create</h1>
            <section>
                <h2>Appointment</h2>
                <hr />
                <EditForm method="post" Model="Appointment" OnValidSubmit="AddAppointment" FormName="create" Enhance>
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" role="alert" />

                    <div class="form-floating mb-3">
                        <InputSelect id="customer_id" @bind-Value="Appointment.Customer_Id" class="form-select">
                            <option value="">-- Select customer --</option>
                            @foreach (var c in Customers)
                            {
                                <option value="@c.Customer_Id">@($"{c.Fname} {c.Lname}")</option>
                            }
                        </InputSelect>
                        <label for="customer_id">Customer</label>
                        <ValidationMessage For="() => Appointment.Customer_Id" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">New to our System?</label>
                        <a href="/clientcustomercreate" id="createCustomer" class="btn btn-secondary btn-sm ms-2">Create Customer</a>
                    </div>

                    <div class="form-floating mb-3">
                        <InputSelect id="employee_id" @bind-Value="Appointment.Employee_Id" class="form-select">
                            <option value="">-- Select employee --</option>
                            @foreach (var e in Employees)
                            {
                                <option value="@e.EmployeeId">@($"{e.FName} {e.LName}")</option>
                            }
                        </InputSelect>
                        <label for="employee_id">Employee</label>
                        <ValidationMessage For="() => Appointment.Employee_Id" class="text-danger" />
                    </div>

                    <div class="form-floating mb-3">
                        <!-- bind to a local property so setter runs reliably when selection changes -->
                        <InputSelect id="service_id" @bind-Value="SelectedServiceId" class="form-select">
                            <option value="">-- Select service --</option>
                            @foreach (var s in Services)
                            {
                                <option value="@s.Service_Id">@($"{s.Name} ({s.Duration}m) - {s.Price:C}")</option>
                            }
                        </InputSelect>
                        <label for="service_id">Service</label>
                        <ValidationMessage For="() => Appointment.Service_Id" class="text-danger" />
                    </div>

                    <div class="form-floating mb-3">
                        <InputDate Type="InputDateType.DateTimeLocal" id="date" @bind-Value="Appointment.Date" class="form-control" />
                        <label for="date">Date</label>
                        <ValidationMessage For="() => Appointment.Date" class="text-danger" />
                    </div>

                    <div class="form-floating mb-3">
                        <InputDate Type="InputDateType.DateTimeLocal" id="start" @bind-value="Appointment.Start" class="form-control" disabled />
                        <label for="start">Start</label>
                        <ValidationMessage For="() => Appointment.Start" class="text-danger" />
                    </div>

                    <div class="form-floating mb-3">
                        <InputText id="status" @bind-Value="Appointment.Status" class="form-control" disabled />
                        <label for="status">Status</label>
                        <ValidationMessage For="() => Appointment.Status" class="text-danger" />
                    </div>

                    <div class="form-floating mb-3">
                        <InputText id="notes" @bind-Value="Appointment.Notes" class="form-control" />
                        <label for="notes">Notes</label>
                        <ValidationMessage For="() => Appointment.Notes" class="text-danger" />
                    </div>

                    <div class="form-floating mb-3">
                        <InputNumber id="price" @bind-Value="Appointment.Price" class="form-control" disabled />
                        <label for="price">Price</label>
                        <ValidationMessage For="() => Appointment.Price" class="text-danger" />
                    </div>

                    <div class="form-floating mb-3">
                        <InputNumber id="duration" @bind-Value="Appointment.Duration" class="form-control" disabled />
                        <label for="duration">Duration (minutes)</label>
                        <ValidationMessage For="() => Appointment.Duration" class="text-danger" />
                    </div>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="text-danger mb-2">@ErrorMessage</div>
                    }

                    <div>
                        <button type="submit" class="w-100 btn btn-lg btn-primary">Create</button>
                    </div>
                </EditForm>
            </section>
        </div>

        <div class="panel-card" style="flex: 0 0 320px;">
            <section>
                <h3>Summary & Tips</h3>
                <hr />
                <p><strong>Selected Service:</strong> @(Services.FirstOrDefault(s => s.Service_Id == Appointment.Service_Id)?.Name ?? "—")</p>
                <p><strong>Duration:</strong> @Appointment.Duration m</p>
                <p><strong>Price:</strong> @Appointment.Price:C</p>

                <p>If you need to add a new customer first, use the Create Customer button on the form.</p>

                <p class="mt-3">
                    <a class="btn btn-outline-secondary w-100" href="/appointments">Back to appointments</a>
                </p>
            </section>
        </div>
    </div>
</div>

@if (Services?.Any() == true)
{
    <pre>@System.Text.Json.JsonSerializer.Serialize(Services, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
}

@code {
    private List<Customer> Customers { get; set; } = new();
    private List<Service> Services { get; set; } = new();
    private List<Employee> Employees { get; set; } = new();
    private string? ErrorMessage;
    private ILogger? _logger;

    [SupplyParameterFromForm]
    private Appointment Appointment { get; set; } = default!;

    // Local property used for binding so setter runs after selection changes.
    private int? SelectedServiceId
    {
        get => Appointment.Service_Id;
        set
        {
            _logger?.LogDebug("SelectedServiceId setter: incoming value={Value}", value);
            Appointment.Service_Id = value;

            if (value is null)
            {
                Appointment.Duration = 0;
                Appointment.Price = 0m;
                StateHasChanged();
                _logger?.LogDebug("SelectedServiceId setter: cleared selection");
                return;
            }

            var svc = Services.FirstOrDefault(s => s.Service_Id == value.Value);
            if (svc is not null)
            {
                Appointment.Duration = svc.Duration;
                CalculatePrice();
                _logger?.LogInformation("Selected service: Id={Id} Name={Name} Price={Price} Duration={Duration} -> Appointment.Price={ApptPrice}",
                    svc.Service_Id, svc.Name, svc.Price, svc.Duration, Appointment.Price);
            }
            else
            {
                _logger?.LogWarning("SelectedServiceId setter: service {Id} not found in Services list", value);
                Appointment.Duration = 0;
                Appointment.Price = 0m;
            }

            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _logger = LoggerFactory.CreateLogger("Make-Appointment");
        Appointment ??= new Appointment { Date = DateTime.Now.Date, Start = TimeOnly.FromDateTime(DateTime.Now), Duration = 60, Status = "Scheduled" };

        try
        {
            using var context = DbFactory.CreateDbContext();
            Customers = await context.Customer.OrderBy(c => c.Fname).ToListAsync();
            Services = await context.Service.OrderBy(s => s.Name).ToListAsync();
            Employees = await context.Employee.OrderBy(e => e.FName).ToListAsync();

            _logger?.LogInformation("OnInitializedAsync: loaded Customers={Count}, Services={Count}, Employees={Count}",
                Customers.Count, Services.Count, Employees.Count);

            foreach (var s in Services)
            {
                _logger?.LogInformation("Service row: Id={Id} Name={Name} Price={Price} Duration={Duration}",
                    s.Service_Id, s.Name ?? "<null>", s.Price, s.Duration);
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "OnInitializedAsync: failed loading data from DB");
            throw;
        }

        // initialize price for default selection (if any)
        CalculatePrice();
    }

    private void CalculatePrice()
    {
        _logger?.LogDebug("CalculatePrice: Appointment.Service_Id={ServiceId}, Appointment.Duration={Duration}, Appointment.Price(before)={Price}",
            Appointment.Service_Id, Appointment.Duration, Appointment.Price);

        Appointment.Price = 0m;

        if (!Appointment.Service_Id.HasValue)
        {
            _logger?.LogDebug("CalculatePrice: no Service_Id selected");
            return;
        }

        var svc = Services.FirstOrDefault(s => s.Service_Id == Appointment.Service_Id.Value);
        if (svc == null)
        {
            _logger?.LogWarning("CalculatePrice: service not found for id {Id}", Appointment.Service_Id.Value);
            return;
        }

        if (svc.Duration <= 0)
        {
            _logger?.LogWarning("CalculatePrice: service {Id} has non-positive Duration={Duration}", svc.Service_Id, svc.Duration);
            return;
        }

        var ratio = (decimal)Appointment.Duration / svc.Duration;
        var computed = Math.Round(svc.Price * ratio, 2);
        Appointment.Price = computed;

        _logger?.LogInformation("CalculatePrice: svc.Id={Id} svc.Price={SvcPrice} svc.Duration={SvcDuration} ratio={Ratio} computedPrice={Computed}",
            svc.Service_Id, svc.Price, svc.Duration, ratio, computed);
    }

    private async Task AddAppointment()
    {
        _logger?.LogDebug("AddAppointment: starting. Appointment.Service_Id={ServiceId} Duration={Duration} Price(before)={Price}",
            Appointment.Service_Id, Appointment.Duration, Appointment.Price);

        ErrorMessage = null;

        using var context = DbFactory.CreateDbContext();

        if (!Appointment.Customer_Id.HasValue)
        {
            ErrorMessage = "Please select a customer.";
            return;
        }
        if (!Appointment.Service_Id.HasValue)
        {
            ErrorMessage = "Please select a service.";
            return;
        }

        var customerExists = await context.Customer.AnyAsync(c => c.Customer_Id == Appointment.Customer_Id.Value);
        if (!customerExists)
        {
            ErrorMessage = "Selected customer does not exist. Please choose an existing customer.";
            return;
        }

        var serviceExists = await context.Service.AnyAsync(s => s.Service_Id == Appointment.Service_Id.Value);
        if (!serviceExists)
        {
            ErrorMessage = "Selected service does not exist. Please choose an existing service.";
            return;
        }

        if (Appointment.Employee_Id.HasValue)
        {
            var employeeExists = await context.Employee.AnyAsync(e => e.EmployeeId == Appointment.Employee_Id.Value);
            if (!employeeExists)
            {
                ErrorMessage = "Selected employee does not exist. Please choose an existing employee.";
                return;
            }
        }

        // ensure price is correct before save
        CalculatePrice();
        _logger?.LogInformation("AddAppointment: ready to save. Appointment.Service_Id={ServiceId} Duration={Duration} Price(final)={Price}",
            Appointment.Service_Id, Appointment.Duration, Appointment.Price);

        context.Appointment.Add(Appointment);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/appointments");
    }
}