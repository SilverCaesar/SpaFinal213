@page "/customerAppointment"
@using Microsoft.EntityFrameworkCore
@using SpaFinal213.Models
@inject IDbContextFactory<SpaFinal213.Data.ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<!-- This script is BAD. Needs actual database writing capability-->
<h3>Schedule an Appointment</h3>

<div class="card p-3 mb-3">
    <label class="form-label">Choose existing customer or create new</label>
    <InputSelect TValue="int" class="form-select" @bind-Value="SelectedCustomerId">
        <option value="0">-- Create new customer --</option>
        @foreach (var c in Customers)
        {
            <option value="@c.Customer_Id">@($"{c.Fname} {c.Lname}")</option>
        }
    </InputSelect>
</div>

@if (SelectedCustomerId == 0)
{
    <div class="card p-3 mb-3">
        <h5>Create Customer</h5>
        <EditForm Model="NewCustomer" OnValidSubmit="OnCreateAndSchedule">
            <DataAnnotationsValidator />
            <div class="mb-3">
                <label class="form-label">First name</label>
                <InputText class="form-control" @bind-Value="NewCustomer.Fname" />
                <ValidationMessage For="() => NewCustomer.Fname" />
            </div>
            <div class="mb-3">
                <label class="form-label">Last name</label>
                <InputText class="form-control" @bind-Value="NewCustomer.Lname" />
                <ValidationMessage For="() => NewCustomer.Lname" />
            </div>
            <div class="mb-3">
                <label class="form-label">Notes</label>
                <InputTextArea class="form-control" @bind-Value="NewCustomer.Notes" />
            </div>

            <h5 class="mt-3">Appointment</h5>
            @* Inline declarative appointment fields (replaces the RenderFragment builder) *@
            <div class="mb-3">
                <label class="form-label">Service</label>
                <InputSelect TValue="int" class="form-select" @bind-Value="SelectedServiceId">
                    <option value="0">Choose...</option>
                    @foreach (var s in Services)
                    {
                        <option value="@s.Service_Id">@s.Name</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">Prefer employee (optional)</label>
                <InputSelect TValue="int" class="form-select" @bind-Value="SelectedEmployeeId">
                    <option value="0">Any available</option>
                    @foreach (var e in Employees)
                    {
                        <option value="@e.EmployeeId">@($"{e.FName} {e.LName}")</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">Date</label>
                <InputDate @bind-Value="AppointmentDate" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Time</label>
                <input type="time" class="form-control" value="@BindConverter.FormatValue(AppointmentTime.HasValue ? AppointmentTime.Value.ToString(@"hh\:mm") : "")"
                       @onchange="OnTimeChanged" />
            </div>

            <div class="mb-3">
                <label class="form-label">Notes</label>
                <InputTextArea class="form-control" @bind-Value="AppointmentNotes" />
            </div>

            <div class="d-grid mt-3">
                <button class="btn btn-primary" type="submit">Create customer & schedule</button>
            </div>
        </EditForm>
    </div>
}
else
{
    <div class="card p-3 mb-3">
        <h5>Schedule for @SelectedCustomerName</h5>

        <EditForm Model="AppointmentModel" OnValidSubmit="OnScheduleExisting">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Service</label>
                <InputSelect TValue="int" class="form-select" @bind-Value="SelectedServiceId">
                    <option value="0">Choose...</option>
                    @foreach (var s in Services)
                    {
                        <option value="@s.Service_Id">@s.Name</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">Prefer employee (optional)</label>
                <InputSelect TValue="int" class="form-select" @bind-Value="SelectedEmployeeId">
                    <option value="0">Any available</option>
                    @foreach (var e in Employees)
                    {
                        <option value="@e.EmployeeId">@($"{e.FName} {e.LName}")</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">Date</label>
                <InputDate @bind-Value="AppointmentDate" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Time</label>
                <input type="time" class="form-control" value="@BindConverter.FormatValue(AppointmentTime.HasValue ? AppointmentTime.Value.ToString(@"hh\:mm") : "")"
                       @onchange="OnTimeChanged" />
            </div>

            <div class="mb-3">
                <label class="form-label">Notes</label>
                <InputTextArea class="form-control" @bind-Value="AppointmentNotes" />
            </div>

            <div class="d-grid mt-3">
                <button class="btn btn-primary" type="submit">Schedule appointment</button>
            </div>
        </EditForm>
    </div>
}

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert alert-info">@StatusMessage</div>
}

@code {
    private List<Customer> Customers { get; set; } = new();
    private List<Service> Services { get; set; } = new();
    private List<Employee> Employees { get; set; } = new();

    private int selectedCustomerId;
    private int SelectedCustomerId
    {
        get => selectedCustomerId;
        set
        {
            selectedCustomerId = value;
            UpdateSelectedCustomerName();
        }
    }

    private string SelectedCustomerName { get; set; } = string.Empty;

    private Customer NewCustomer { get; set; } = new();
    private Appointment AppointmentModel { get; set; } = new();

    // Appointment helper fields
    private int SelectedServiceId { get; set; }
    private int SelectedEmployeeId { get; set; }
    private DateTime? AppointmentDate { get; set; }
    private TimeSpan? AppointmentTime { get; set; }
    private string? AppointmentNotes { get; set; }

    private string StatusMessage { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        using var ctx = DbFactory.CreateDbContext();
        Customers = await ctx.Customer.OrderBy(c => c.Fname).ThenBy(c => c.Lname).ToListAsync();
        Services = await ctx.Service.OrderBy(s => s.Service_Id).ToListAsync();
        Employees = await ctx.Employee.OrderBy(e => e.LName).ToListAsync();

        // default choose first existing customer if any
        SelectedCustomerId = Customers.Any() ? Customers.First().Customer_Id : 0;
    }

    private void UpdateSelectedCustomerName()
    {
        var sel = Customers.FirstOrDefault(c => c.Customer_Id == SelectedCustomerId);
        SelectedCustomerName = sel is null ? string.Empty : $"{sel.Fname} {sel.Lname}";
    }

    private void OnTimeChanged(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e?.Value?.ToString() ?? "", out var ts))
        {
            AppointmentTime = ts;
        }
        else
        {
            AppointmentTime = null;
        }
    }

    private async Task OnCreateAndSchedule()
    {
        StatusMessage = string.Empty;

        if (!ValidateAppointmentInputs()) return;

        using var ctx = DbFactory.CreateDbContext();

        NewCustomer.DateAccount = DateTime.UtcNow;
        ctx.Customer.Add(NewCustomer);
        await ctx.SaveChangesAsync();

        var createdId = NewCustomer.Customer_Id;

        var appointment = BuildAppointment(createdId);
        ctx.Appointment.Add(appointment);
        await ctx.SaveChangesAsync();

        StatusMessage = "Customer created and appointment scheduled.";
        NavigationManager.NavigateTo($"/appointments/details?appointment_id={appointment.Appointment_Id}");
    }

    private async Task OnScheduleExisting()
    {
        StatusMessage = string.Empty;

        if (SelectedCustomerId <= 0)
        {
            StatusMessage = "Please select a customer or create a new one.";
            return;
        }

        if (!ValidateAppointmentInputs()) return;

        using var ctx = DbFactory.CreateDbContext();

        var appointment = BuildAppointment(SelectedCustomerId);
        ctx.Appointment.Add(appointment);
        await ctx.SaveChangesAsync();

        StatusMessage = "Appointment scheduled.";
        NavigationManager.NavigateTo($"/appointments/details?appointment_id={appointment.Appointment_Id}");
    }

    private bool ValidateAppointmentInputs()
    {
        if (SelectedServiceId <= 0)
        {
            StatusMessage = "Please choose a service.";
            return false;
        }

        if (!AppointmentDate.HasValue || !AppointmentTime.HasValue)
        {
            StatusMessage = "Please choose date and time.";
            return false;
        }

        return true;
    }

    private Appointment BuildAppointment(int customerId)
    {
        // combine date and time into a DateTime for Start
        var date = AppointmentDate!.Value.Date;
        var start = date + AppointmentTime!.Value;

        var appt = new Appointment
        {
            Customer_Id = customerId,
            Service_Id = SelectedServiceId,
            Employee_Id = SelectedEmployeeId, // if 0, it mirrors other pages which accept an int (adjust if your model uses nullable)
            Date = date,
            Start = start,
            Status = "Scheduled",
            Notes = AppointmentNotes
        };

        return appt;
    }
}