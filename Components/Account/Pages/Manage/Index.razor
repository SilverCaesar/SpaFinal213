@page "/Account/Manage"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using SpaFinal213.Data
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject RoleManager<IdentityRole> RoleManager
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager Navigation
@inject ApplicationDbContext Db

<PageTitle>Profile</PageTitle>

<h3>Profile</h3>

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert alert-success">@StatusMessage</div>
}

<div class="row">
    <div class="col-xl-6">
        <EditForm Model="Input" OnValidSubmit="OnValidSubmitAsync" FormName="ProfileForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <!-- Username -->
            <div class="form-floating mb-3">
                <input type="text" class="form-control" value="@Username" disabled />
                <label>Username</label>
            </div>

            <!-- Phone -->
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.PhoneNumber" class="form-control" />
                <label>Phone number</label>
                <ValidationMessage For="() => Input.PhoneNumber" class="text-danger" />
            </div>

            <!-- Role -->
            <div class="mb-3">
                <label class="form-label">Account role</label>
                <InputSelect @bind-Value="Input.SelectedRole" class="form-select" TValue="string">
                    <option value="">-- none --</option>
                    <option value="Customer">Customer</option>
                    <option value="Employee">Employee</option>
                </InputSelect>
                <div class="form-text">Select either Customer or Employee.</div>
            </div>

            <button type="submit" class="btn btn-primary w-100">Save</button>
        </EditForm>
    </div>
</div>

@code {
    private ApplicationUser UserEntity = default!;
    private string Username = default!;
    private string PhoneNumber = default!;
    private string? StatusMessage;

    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Load user
        UserEntity = await UserAccessor.GetRequiredUserAsync(HttpContext);
        Username = await UserManager.GetUserNameAsync(UserEntity);
        PhoneNumber = await UserManager.GetPhoneNumberAsync(UserEntity);

        Input.PhoneNumber = PhoneNumber;

        // Ensure roles exist
        await EnsureRoleExistsAsync("Customer");
        await EnsureRoleExistsAsync("Employee");

        // Populate current role
        var roles = await UserManager.GetRolesAsync(UserEntity);
        if (roles.Contains("Customer"))
            Input.SelectedRole = "Customer";
        else if (roles.Contains("Employee"))
            Input.SelectedRole = "Employee";
        else
            Input.SelectedRole = string.Empty;
    }

    private async Task OnValidSubmitAsync()
    {
        try
        {
            // Refresh user from UserManager
            var appUser = await UserManager.FindByIdAsync(UserEntity.Id);
            if (appUser is null)
            {
                StatusMessage = "Error: user not found.";
                return;
            }

            // Update phone if changed
            if (Input.PhoneNumber != PhoneNumber)
            {
                var phoneResult = await UserManager.SetPhoneNumberAsync(appUser, Input.PhoneNumber);
                if (!phoneResult.Succeeded)
                {
                    StatusMessage = $"Error updating phone: {string.Join(", ", phoneResult.Errors.Select(e => e.Description))}";
                    return;
                }
                PhoneNumber = Input.PhoneNumber;
            }

            // Ensure the selected role exists
            var selected = Input.SelectedRole?.Trim() ?? string.Empty;
            if (!string.IsNullOrEmpty(selected))
            {
                await EnsureRoleExistsAsync(selected);
            }

            // Directly update AspNetUserRoles (explicit EF approach)
            await UpdateAspNetUserRolesDirectAsync(appUser, selected);

            // Refresh sign-in
            await SignInManager.RefreshSignInAsync(appUser);

            UserEntity = appUser;
            StatusMessage = "Your profile has been updated.";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Unexpected error: {ex.Message}";
        }
    }

    private async Task EnsureRoleExistsAsync(string roleName)
    {
        if (!await RoleManager.RoleExistsAsync(roleName))
        {
            await RoleManager.CreateAsync(new IdentityRole(roleName));
        }
    }

    private async Task UpdateAspNetUserRolesDirectAsync(ApplicationUser appUser, string selectedRole)
    {
        // Roles to consider as mutually exclusive
        var mutuallyExclusive = new[] { "Customer", "Employee" };

        // Load roles metadata for the mutually exclusive set
        var roles = await Db.Set<IdentityRole>()
            .Where(r => mutuallyExclusive.Contains(r.Name))
            .ToListAsync();

        // Remove rows for roles we don't want
        var rolesToRemove = roles.Where(r => r.Name != selectedRole).Select(r => r.Id).ToList();

        var userRoles = Db.Set<IdentityUserRole<string>>();

        var entriesToRemove = await userRoles
            .Where(ur => ur.UserId == appUser.Id && rolesToRemove.Contains(ur.RoleId))
            .ToListAsync();

        if (entriesToRemove.Any())
            userRoles.RemoveRange(entriesToRemove);

        // Add selected role row if requested and not already present
        if (!string.IsNullOrEmpty(selectedRole))
        {
            var role = roles.FirstOrDefault(r => r.Name == selectedRole)
                       ?? await Db.Set<IdentityRole>().FirstOrDefaultAsync(r => r.Name == selectedRole);

            if (role != null)
            {
                var exists = await userRoles.AnyAsync(ur => ur.UserId == appUser.Id && ur.RoleId == role.Id);
                if (!exists)
                {
                    userRoles.Add(new IdentityUserRole<string> { UserId = appUser.Id, RoleId = role.Id });
                }
            }
            else
            {
                // If role doesn't exist in Roles table, create it via RoleManager to keep consistency
                var createResult = await RoleManager.CreateAsync(new IdentityRole(selectedRole));
                if (createResult.Succeeded)
                {
                    var createdRole = await Db.Set<IdentityRole>().FirstAsync(r => r.Name == selectedRole);
                    userRoles.Add(new IdentityUserRole<string> { UserId = appUser.Id, RoleId = createdRole.Id });
                }
            }
        }

        await Db.SaveChangesAsync();
    }

    private class InputModel
    {
        [Phone]
        [Display(Name = "Phone number")]
        public string? PhoneNumber { get; set; }

        [Display(Name = "Role")]
        public string? SelectedRole { get; set; }
    }

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;
}
